<p-toast></p-toast>
<div class="sfc-header">
  <div class="left-section">
    <span class="title">Smiline Family Club</span>
  </div>
</div>

<div class="sfc-action-bar">
  <div class="sfc-controls">
    <i class="pi pi-search search-icon"></i>
    <input
      type="text"
      [(ngModel)]="searchTerm"
      placeholder="Search Name / ID / ..."
      class="sfc-search-bar"
    />
  </div>
  <div class="sfc-action-buttons">
  <button type="submit" class="btn-primary" [ngClass]="{'disabled': !isSFCFormValid}" (click)="addEntry()" [disabled]="!isSFCFormValid">
    <i 
      [ngClass]="editingIndex !== null ? 'fa-solid fa-pen-to-square' : 'fa-solid fa-plus'" 
      style="margin-right: 6px;">
    </i>
    {{ editingIndex !== null ? 'Update Members to SFC' : 'Add Members to SFC' }}
  </button>
</div>
</div>


<form (ngSubmit)="addEntry()">
  <div
    style="display: flex; align-items: flex-end; margin-bottom: 0.5rem"
  ></div>
  <div class="sfc-table-scroll">
    <div class="sfc-scrollbar">
    <table class="sfc-table">
      <thead class="sfc-header-static">
        <tr>
          <th>Date</th>
          <th>Patient Name</th>
          <th>Patient Id</th>
          <th>Age</th>
          <th>Occupation</th>
          <th>Smiline Patient (Y/N)</th>
          <th>Doctors & Front Office Comment on Previous Work</th>
          <th>Doctor Advice for Lead Generation</th>
          <th>Front Office Remarks</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <!-- Row for new entry -->
        <tr>
          <td>
           <div 
  class="date-input-container" 
  [ngStyle]="editingIndex !== null ? {'pointer-events': 'none', 'opacity': '0.7', 'cursor': 'not-allowed'} : {}"
>
  <app-custom-calendar
    [selectedDate]="newEntry.date"
    [isInvalid]="isFieldInvalid('date')"
    (dateSelected)="onDateSelected($event); onFormTouched()"
  ></app-custom-calendar>
</div>
            <div *ngIf="isFieldInvalid('date')" class="error-msg"></div>
          </td>
          <td>

<input
  [(ngModel)]="newEntry.name"
  (ngModelChange)="onFormTouched()"
  name="name"
  maxlength="150"
  required
  [required]="editingIndex === null"
  [readonly]="editingIndex !== null"
  [class.invalid-field]="isFieldInvalid('name')"
  [class.readonly-field]="editingIndex !== null"
/>
<div *ngIf="isFieldInvalid('name')" class="error-msg"></div>

<td>
  <div class="patient-search-container" *ngIf="editingIndex === null">
    <input
  [(ngModel)]="newEntry.patientId"
  (ngModelChange)="onFormTouched()"
      name="patientId"
      placeholder="Search Patient ID..."
      (input)="onPatientIdInput($event)"
      (focus)="showPatientSearch = true"
      [class.invalid-field]="isFieldInvalid('patientId') || (patientSearchResults.length === 0 && newEntry.patientId.trim().length >= 2)"
    />
    
    <!-- Patient Search Dropdown -->
    <div class="patient-search-dropdown" *ngIf="showPatientSearch && newEntry.patientId.trim().length > 0">
      <!-- Loading indicator -->
      <div class="search-loading" *ngIf="isSearchingPatients">
        <i class="pi pi-spinner pi-spin"></i>
        <span>Searching patients...</span>
      </div>
      
      <!-- Search results -->
      <div class="search-results" *ngIf="!isSearchingPatients && patientSearchResults.length > 0">
        <div *ngFor="let patient of patientSearchResults" 
             class="search-result-item" 
             (click)="selectPatient(patient)">
          <div class="patient-info">
            <div class="patient-name">{{ patient.name }}</div>
            <div class="patient-details">
              <span class="patient-id">ID: {{ patient.manual_unique_code || patient.id }}</span>
              <span class="patient-phone">{{ patient.phone }}</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- No results found -->
      <div class="no-results" *ngIf="!isSearchingPatients && patientSearchResults.length === 0 && newEntry.patientId.trim().length >= 2">
        <i class="pi pi-search"></i>
        <span>No patients found</span>
      </div>
      
      <!-- Minimum character requirement -->
      <div class="search-hint" *ngIf="!isSearchingPatients && newEntry.patientId.trim().length > 0 && newEntry.patientId.trim().length < 2">
        <i class="pi pi-info-circle"></i>
        <span>Type at least 2 characters to search</span>
      </div>
    </div>
  </div>
  
  <!-- Readonly input for editing mode -->
  <input
    *ngIf="editingIndex !== null"
    [(ngModel)]="newEntry.patientId"
    name="patientId"
    [class.invalid-field]="isFieldInvalid('patientId')"
    [readonly]="true"
    [class.readonly-field]="true"
  />
  
  <div *ngIf="isFieldInvalid('patientId')" class="error-msg"></div>
</td>

<td>
  <input
    type="number"
  [(ngModel)]="newEntry.ageRelation"
  (ngModelChange)="onFormTouched()"
    name="ageRelation"
    max="200"
    min="0"
    required
    [class.invalid-field]="isFieldInvalid('ageRelation')"
    [readonly]="editingIndex !== null"
    [class.readonly-field]="editingIndex !== null"
/>
            <div *ngIf="isFieldInvalid('ageRelation')" class="error-msg">
              
            </div>
          </td>
          <td>
            <input
            [(ngModel)]="newEntry.profileOccupation"
            (ngModelChange)="onFormTouched()"
              name="profileOccupation"
              required
              [class.invalid-field]="isFieldInvalid('profileOccupation')"
            />
            <div *ngIf="isFieldInvalid('profileOccupation')" class="error-msg">
              
            </div>
          </td>
          <td>
            <select
  [(ngModel)]="newEntry.smilinePatient"
  (ngModelChange)="onFormTouched()"
  name="smilinePatient"
  required
  [class.invalid-field]="isFieldInvalid('smilinePatient')"
  [disabled]="editingIndex !== null"
  [class.readonly-field]="editingIndex !== null"
>
  <option value="Y">Y</option>
  <option value="N">N</option>
</select>
<div *ngIf="isFieldInvalid('smilinePatient')" class="error-msg">
  <!-- error message here -->
</div>

          </td>
          <td>
            <input
            [(ngModel)]="newEntry.doctorFrontOfficeComment"
            (ngModelChange)="onFormTouched()"
              name="doctorFrontOfficeComment"
              maxlength="150"
              [class.invalid-field]="isFieldInvalid('doctorFrontOfficeComment')"
            />
            <div
              *ngIf="isFieldInvalid('doctorFrontOfficeComment')"
              class="error-msg"
            >
            
            </div>
          </td>
          <td>
            <input
            [(ngModel)]="newEntry.doctorAdvice"
            (ngModelChange)="onFormTouched()"
              name="doctorAdvice"
              maxlength="150"
              [class.invalid-field]="isFieldInvalid('doctorAdvice')"
            />
            <div *ngIf="isFieldInvalid('doctorAdvice')" class="error-msg">
              
            </div>
          </td>
          <td>
            <input
            [(ngModel)]="newEntry.frontOfficeRemarks"
            (ngModelChange)="onFormTouched()"
              name="newEntry.frontOfficeRemarks"
              [class.invalid-field]="isFieldInvalid('frontOfficeRemarks')"
            />
            <div *ngIf="isFieldInvalid('frontOfficeRemarks')" class="error-msg">
              
            </div>
          </td>
          <td></td>
        </tr>
        <!-- Existing entries with search and pagination -->
        <tr *ngFor="let entry of paginatedEntries(); let i = index">
          <td>{{ entry.date }}</td>
          <td>{{ entry.name }}</td>
          <td>{{ entry.patientId }}</td>
          <td>{{ entry.ageRelation }}</td>
          <td>{{ entry.profileOccupation }}</td>
          <td>{{ entry.smilinePatient }}</td>
          <td>{{ entry.doctorFrontOfficeComment }}</td>
          <td>{{ entry.doctorAdvice }}</td>
          <td>{{ entry.frontOfficeRemarks }}</td>
          <td class="action-column">
            <div class="action-dropdown" (click)="$event.stopPropagation()">
              <button 
                class="action-trigger" 
               (click)="toggleDropdown(i, $event)"
                type="button"
              >
                <i [class]="openDropdownIndex === i ? 'fa-solid fa-chevron-up' : 'fa-solid fa-chevron-down'"></i>
              </button>
              <div 
                class="dropdown-menu" 
                [class.show]="openDropdownIndex === i"
              >
                <button 
                  class="dropdown-item edit-item" 
                  (click)="editEntry(entry)"
                  type="button"
                >
                  <i class="fa-solid fa-pen-to-square"></i>
                  <span>Edit</span>
                </button>
                <button 
                  class="dropdown-item delete-item" 
                  (click)="removeEntry(entry)"
                  type="button"
                >
                  <i class="fa-solid fa-trash"></i>
                  <span>Delete</span>
                </button>
              </div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    </div>
  </div>
</form>

<!-- Add click listener to close dropdown when clicking outside -->
<div class="dropdown-overlay" 
     *ngIf="openDropdownIndex !== null" 
     (click)="closeDropdown()">
</div>

<div class="sfc-pagination">
  <span class="pagination-info">
    Showing {{ startIndex + 1 }} to {{ endIndex }} of
    {{ filteredEntries().length }} entries
  </span>

  <ul class="pagination-list">
    <li [class.disabled]="currentPage === 1" (click)="goToPage(1)">
      <i class="fa-solid fa-angles-left"></i>
    </li>
    <li [class.disabled]="currentPage === 1" (click)="prevPage()">
      <i class="fa-solid fa-angle-left"></i>
    </li>

    <li
      *ngFor="let page of paginationRange()"
      [class.active]="currentPage === page"
      (click)="goToPage(page)"
    >
      {{ page }}
    </li>

    <li [class.disabled]="currentPage === totalPages()" (click)="nextPage()">
      <i class="fa-solid fa-angle-right"></i>
    </li>
    <li
      [class.disabled]="currentPage === totalPages()"
      (click)="goToPage(totalPages())"
    >
      <i class="fa-solid fa-angles-right"></i>
    </li>
  </ul>
</div>