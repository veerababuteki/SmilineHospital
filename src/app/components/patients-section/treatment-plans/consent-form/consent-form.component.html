<!-- Updated consent-form.component.html -->
<p-toast></p-toast>
<div class="consent-form-container">
  <!-- <div class="dialog-header">
    <h2>Consent Forms</h2>
    <button class="close-btn" (click)="closeDialog.emit()">×</button>
  </div> -->
  <!-- Mode Selection -->
  <div class="mode-selection" *ngIf="!selectedMode && !viewOnly">
    <h2>Select Action</h2>
    <div class="mode-buttons">
      <button class="btn btn-primary mode-btn" (click)="selectMode('download')">
        Download Form
      </button>
      <button class="btn btn-secondary mode-btn" (click)="selectMode('upload')">
        Upload Form
      </button>
    </div>
    <!-- Uploaded Files List -->
      <div class="uploaded-files" *ngIf="uploadedForms.length > 0 && !shouldShowNoConsentMessage()">
        <h4 *ngIf="!viewOnly">Consent Forms:</h4>
        <div class="file-list">
          <div *ngFor="let file of uploadedForms; let i = index" class="file-item">
            <div class="file-info">
              <span class="file-name" [title]="file.name">{{ file.name.length > 30 ? (file.name | slice:0:30) + '...' : file.name }}</span>
              <span class="upload-date">{{ file.uploadDate | date:'short' }}</span>
              <span class="file-status" *ngIf="file.isExisting">✓ Uploaded</span>
            </div>
            <div class="file-actions">
              <button 
                class="btn btn-primary btn-sm" 
                *ngIf="file.file_path"
                (click)="downloadConsentForm(file.file_path, file.name)">
                Download
              </button>
              <button 
                class="btn btn-danger btn-sm" 
                *ngIf="!file.isExisting"
                (click)="removeUploadedForm(i)">
                Remove
              </button>
              <button 
                class="btn btn-danger btn-sm" 
                *ngIf="file.isExisting && !viewOnly"
                (click)="deleteConsentForm(file.id)">
                Delete
              </button>
            </div>
          </div>
        </div>
      </div>
  </div>

  <!-- Download Mode -->
  <div *ngIf="selectedMode === 'download'">
    <div class="mode-header">
      <h2>INFORMED CONSENT FORM - Download</h2>
      <button class="btn btn-outline" (click)="goBack()">← Back to Selection</button>
    </div>

    <!-- Single Form -->
    <form [formGroup]="consentForm" class="consent-form">
      <!-- Basic Information -->
      <div class="basic-info">
        <div class="info-row">
          <div class="form-group">
            <label for="patientName">Patient Name:</label>
            <input 
              type="text" 
              id="patientName" 
              formControlName="patientName"
              class="form-control"
              placeholder="Enter patient name">
          </div>
           <div class="form-group">
          <label for="doctorName">Doctor's Name:</label>
          <input 
            type="text" 
            id="doctorName" 
            formControlName="doctorName"
            class="form-control"
            placeholder="Enter doctor's name">
        </div>
        </div>
       
        <div class="form-group">
            <!-- <label for="date">Date:</label> -->
            <input 
              type="date" 
              id="date" 
              formControlName="date"
              hidden
              class="form-control">
          </div>
      </div>

      <!-- Consent Sections -->
      <div class="consent-sections" formGroupName="sections">
        <h3>Select Applicable Sections:</h3>
        
        <div class="sections-grid">
          <div *ngFor="let sectionKey of getSectionKeys()" class="section-item">
            <div class="section-checkbox">
              <input 
                type="checkbox" 
                [id]="sectionKey"
                [formControlName]="sectionKey">
              <label [for]="sectionKey">
                {{ sectionDescriptions[sectionKey].title }}
              </label>
            </div>
            
            <div class="section-content" *ngIf="consentForm.get('sections')?.get(sectionKey)?.value">
              <p>{{ sectionDescriptions[sectionKey].content }}</p>
              <div class="signature-row">
                <span>Patient Signature: ____________________</span>
                <span>Doctor's Signature: ____________________</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>

    <!-- Download Buttons -->
    <div class="action-buttons">
      <button 
        class="btn btn-primary"
        [disabled]="!isFormValid()"
        (click)="downloadFormAsPDF()">
        Download Form as PDF
      </button>
      <button 
        class="btn btn-success"
        [disabled]="!isFormValid()"
        (click)="requestSignaturesAndDownload()">
        Download Signed Form
      </button>
    </div>

    <!-- Form Status -->
    <div class="form-status">
      <div class="status-info">
        <p><strong>Form Status:</strong> 
          <span [class]="isFormValid() ? 'valid' : 'invalid'">
            {{ isFormValid() ? 'Complete' : 'Incomplete' }}
          </span>
        </p>
      </div>
    </div>
  </div>

  <!-- Upload Mode -->
  <div *ngIf="selectedMode === 'upload'">
    <div class="mode-header" *ngIf="!viewOnly">
      <h2>Upload Completed Forms</h2>
      <button class="btn btn-outline" (click)="goBack()">← Back to Selection</button>
    </div>

    <!-- File Upload Section -->
    <div class="upload-section">
      <!-- Loading indicator -->
      <div *ngIf="isLoadingExistingForms" class="loading-message">
        <p>Loading consent forms...</p>
      </div>

      <!-- No consent forms message -->
      <div *ngIf="shouldShowNoConsentMessage()" class="no-consent-message">
        <p><strong>No signed Consent form available</strong></p>
      </div>

      <!-- Only show upload area if not in view-only mode -->
      <div class="upload-area" *ngIf="!viewOnly">
        <input 
          type="file" 
          id="fileInput"
          accept=".pdf"
          (change)="onFileSelected($event)"
          style="display: none;">
        <label for="fileInput" class="upload-button">
          Choose PDF File
        </label>
        <p class="upload-hint">Select a PDF file to upload</p>
      </div>

      <!-- Upload Button -->
      <div class="upload-actions" *ngIf="getNewFilesCount() > 0 && !viewOnly">
        <button 
          class="btn btn-primary upload-btn"
          [disabled]="isLoading"
          (click)="uploadConsentForms()">
          {{ isLoading ? 'Uploading...' : 'Upload Forms' }}
        </button>
      </div>

      <!-- Uploaded Files List -->
      <div class="uploaded-files" *ngIf="uploadedForms.length > 0 && !shouldShowNoConsentMessage()">
        <h4 *ngIf="!viewOnly">Consent Forms:</h4>
        <div class="file-list">
          <div *ngFor="let file of uploadedForms; let i = index" class="file-item">
            <div class="file-info">
              <span class="file-name" [title]="file.name">{{ file.name.length > 30 ? (file.name | slice:0:30) + '...' : file.name }}</span>
              <span class="upload-date">{{ file.uploadDate | date:'short' }}</span>
              <span class="file-status" *ngIf="file.isExisting">✓ Uploaded</span>
            </div>
            <div class="file-actions">
              <button 
                class="btn btn-primary btn-sm" 
                *ngIf="file.file_path"
                (click)="downloadConsentForm(file.file_path, file.name)">
                Download
              </button>
              <button 
                class="btn btn-danger btn-sm" 
                *ngIf="!file.isExisting"
                (click)="removeUploadedForm(i)">
                Remove
              </button>
              <button 
                class="btn btn-danger btn-sm" 
                *ngIf="file.isExisting && !viewOnly"
                (click)="deleteConsentForm(file.id)">
                Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Digital Signature Modal -->
  <div *ngIf="showSignatureMode" class="signature-modal-overlay">
    <div class="signature-modal">
      <div class="signature-modal-header">
        <h2>Add Signatures for Signed Form</h2>
        <button class="btn btn-outline" (click)="closeSignatureMode()">×</button>
      </div>

      <div class="signature-container">
        <div class="signature-section">
          <p class="signature-instructions">
            Please add signatures to generate the signed consent form. 
            You can draw signatures using your mouse/touch or upload signature images.
          </p>
          
          <!-- Auto-upload toggle -->
          <div class="auto-upload-toggle">
            <label class="toggle-label">
              <input 
                type="checkbox" 
                [(ngModel)]="autoUploadSignedForm"
                class="toggle-checkbox">
              <span class="toggle-text">
                {{ autoUploadSignedForm ? '✓' : '○' }} Auto-upload signed form after generation
              </span>
            </label>
            <small class="toggle-hint">
              When enabled, the signed form will be automatically uploaded to the server. 
              When disabled, it will be downloaded to your device.
            </small>
            <small class="file-size-warning">
              ⚠️ Note: Server upload limit is 10MB. Files are now optimized for smaller sizes (typically under 1MB).
            </small>
          </div>
          
          <div class="signature-pads">
            <div class="signature-pad-wrapper">
              <app-signature-pad 
                title="Patient Signature"
                (signatureChange)="onPatientSignatureChange($event)">
              </app-signature-pad>
            </div>
            
            <div class="signature-pad-wrapper">
              <app-signature-pad 
                title="Doctor's Signature"
                (signatureChange)="onDoctorSignatureChange($event)">
              </app-signature-pad>
            </div>
          </div>

          <div class="signature-actions">
            <button 
              class="btn btn-secondary"
              (click)="closeSignatureMode()"
              [disabled]="isLoading">
              Cancel
            </button>
            <button 
              class="btn btn-primary"
              [disabled]="!currentSignatures.patientSignature && !currentSignatures.doctorSignature || isLoading"
              (click)="saveSignaturesAndDownload()">
              <span *ngIf="!isLoading">
                {{ autoUploadSignedForm ? 'Save & Upload' : 'Save & Download' }}
              </span>
              <span *ngIf="isLoading">
                {{ autoUploadSignedForm ? 'Uploading...' : 'Generating...' }}
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>